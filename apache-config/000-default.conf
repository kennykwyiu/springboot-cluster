# Default Apache site configuration for Spring Boot Cluster
# This file provides a simplified configuration for setting up Apache as a load balancer
# for the Spring Boot cluster. It is intended to be placed in /etc/apache2/sites-available/.

<VirtualHost *:80>
    ServerAdmin webmaster@localhost # Email address of the server administrator.
    ServerName localhost # The hostname that this virtual host responds to.
    DocumentRoot /var/www/html # The directory from which Apache will serve files.

    # Enable required modules (ensure these are enabled in Apache)
    # These modules are essential for proxying, load balancing, and header manipulation.
    # You can enable them using commands like: sudo a2enmod proxy
    # a2enmod proxy
    # a2enmod proxy_http
    # a2enmod proxy_balancer
    # a2enmod lbmethod_byrequests
    # a2enmod headers
    # a2enmod rewrite

    # Define the backend cluster configuration.
    ProxyRequests Off # Disables forward proxying.
    ProxyPreserveHost On # Passes the original Host header to the backend.

    # Define the proxy balancer, which lists the backend Spring Boot nodes.
    <Proxy balancer://springboot-cluster>
        # BalancerMember defines each node in the cluster.
        # http://127.0.0.1:8081 is Node1, and route=node1 is used for sticky sessions.
        BalancerMember http://127.0.0.1:8081 route=node1
        # http://127.0.0.1:8082 is Node2, and route=node2 is used for sticky sessions.
        BalancerMember http://127.0.0.1:8082 route=node2
        ProxySet lbmethod=byrequests # Load balancing method: distribute requests by the number of requests served.
    </Proxy>

    # Rewrite rules for sticky sessions.
    # This ensures that a user's subsequent requests are routed to the same backend server.
    RewriteEngine On # Enables the rewrite engine.
    # Checks if the CLUSTERSESSIONID cookie exists and extracts the route ID from it.
    RewriteCond %{HTTP_COOKIE} CLUSTERSESSIONID=([^;]+)\.([^;]+)
    # Sets an environment variable ROUTEID with the extracted route ID.
    RewriteRule ^(.*)$ $1 [E=ROUTEID:%2]

    # Proxy configuration for routing requests to the backend cluster.
    ProxyPass /balancer-manager ! # Excludes the balancer manager URL from being proxied.
    # Proxies all other requests to the springboot-cluster balancer.
    # stickysession=CLUSTERSESSIONID tells Apache to use this cookie for session affinity.
    ProxyPass / balancer://springboot-cluster/ stickysession=CLUSTERSESSIONID
    # Adjusts the URL in Location, Content-Location, and URI headers in HTTP responses.
    ProxyPassReverse / balancer://springboot-cluster/

    # Balancer manager for monitoring and managing the load balancer.
    <Location "/balancer-manager">
        SetHandler balancer-manager # Activates the balancer manager handler.
        Require local # Restricts access to the balancer manager to local connections only.
    </Location>

    # Security headers to enhance the application's security posture.
    Header always set X-Frame-Options "DENY" # Prevents clickjacking attacks.
    Header always set X-Content-Type-Options "nosniff" # Prevents MIME-sniffing vulnerabilities.
    Header always set X-XSS-Protection "1; mode=block" # Enables XSS protection in browsers.

    # Logging configuration for this virtual host.
    ErrorLog ${APACHE_LOG_DIR}/error.log # Specifies the error log file.
    CustomLog ${APACHE_LOG_DIR}/access.log combined # Specifies the access log file and format.
</VirtualHost>

