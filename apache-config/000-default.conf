# Default Apache site configuration for Spring Boot Cluster
# This file should be placed in /etc/apache2/sites-available/

<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    ServerName localhost
    DocumentRoot /var/www/html

    # Enable required modules (ensure these are enabled)
    # a2enmod proxy
    # a2enmod proxy_http
    # a2enmod proxy_balancer
    # a2enmod lbmethod_byrequests
    # a2enmod headers
    # a2enmod rewrite

    # Define the backend cluster
    ProxyRequests Off
    ProxyPreserveHost On

    # Define proxy balancer
    <Proxy balancer://springboot-cluster>
        BalancerMember http://127.0.0.1:8081 route=node1
        BalancerMember http://127.0.0.1:8082 route=node2
        ProxySet lbmethod=byrequests
    </Proxy>

    # Rewrite rules for sticky sessions
    RewriteEngine On
    RewriteCond %{HTTP_COOKIE} CLUSTERSESSIONID=([^;]+)\.([^;]+)
    RewriteRule ^(.*)$ $1 [E=ROUTEID:%2]

    # Proxy configuration
    ProxyPass /balancer-manager !
    ProxyPass / balancer://springboot-cluster/ stickysession=CLUSTERSESSIONID
    ProxyPassReverse / balancer://springboot-cluster/

    # Balancer manager for monitoring
    <Location "/balancer-manager">
        SetHandler balancer-manager
        Require local
    </Location>

    # Security headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

